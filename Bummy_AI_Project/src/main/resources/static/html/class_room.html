<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<!-- jQuery library -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<!-- 쿠키 설정 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script>
	$(document).ready(function(){
		// 대화 설정
		var user_name=$.cookie('user_name');
		var user_id=$.cookie('user_id');
		let ws, ws_cam;
		let localstream;
		let cam_loop;
		
		let id="["+user_name+"]";
		// HTML5의 내장 객체 WebSocket 생성 + Java class "WebSocket.java"와 연결
		ws=new WebSocket("ws://localhost:8090/classChat");
		// 연결이 되면 아래를 실행 + Java class "WebSocket.java"에서 작성한 메소드 실행
		ws.onopen=function(){
			console.log("con ok");
		}
			// 메시지가 오면 아래를 실행
			ws.onmessage=function(msg){
				console.log(msg.data);
				let oldMsg=$("textarea").val();
				let message=oldMsg+"\n"+msg.data;
				$("textarea").val(message);
			}
		
			// 보내기
			$("#msgBtn").on("click", ()=> {
				let msg = $("#chatMsg").val();
				ws.send(id+msg);
				$("#chatMsg").val("");
				let scrollHeight = $("#chatTxt").prop("scrollHeight");
				$("#chatTxt").scrollTop(scrollHeight);
			})
			
			// 엔터키를 이용하여 전송 
			$("#chatMsg").keypress(function(event){
			     if ( event.which == 13 ) {
			         $('#msgBtn').click();
			         return false;
			     }
			});
		
		// 캡처 설정
		let count=0;
		let timer=setInterval(function(){ 
			navigator.getUserMedia(
				{audio:false, video:true},
				function(stream){
					const track=stream.getVideoTracks()[0];
					let imageCapture=new ImageCapture(track);
					imageCapture.takePhoto().then(function(photo){
						console.log(photo);
						const fileName = user_id+'.jpg';
						let formData = new FormData();
						formData.append('file', photo, fileName);
						$.ajax({
							type : 'post',
							url : '../condition',
							cache : false,
							data : formData,
							processData : false,
							contentType : false,
							success : function(data) {
								console.log(data);
								alert(data);
							}
						});
					});
				},
				function() {
					alert("fail");
				}
			);
			if(++count==1) clearInterval(timer);
		},
		//선생님이 정한 시간
		5000);
		
	});

</script>

</head>
<body>
	<input type="text" id="chatMsg"><input type="button" id="msgBtn" value="전송"><br>
	<textarea id="chatTxt" rows="10" cols="30"></textarea>
</body>
</html>

